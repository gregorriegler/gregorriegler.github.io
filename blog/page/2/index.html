<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="https://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Gregor Riegler &middot; Merciless Refactorer - page 2
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
<meta name="description" content="Gregor Riegler, Software Development Coach."/>
</head>


  <body class="default">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Gregor Riegler
      </a>
    </div>
    <p class="lead">Merciless Refactorer</p>
  </header>
  <nav id="sidebar-nav-links">
  

  


  

  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
      <a class="page-link "
          href="/about">About</a>
    
  

  
    
      <a class="page-link "
          href="/blog">Blog</a>
    
  

  
    
      <a class="page-link "
          href="/speaking">Public Speaking</a>
    
  

  
    
      <a class="page-link "
          href="/refactoring-java/">Refactoring Java Series</a>
    
  



  

  

  


  

  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  

  <nav id="sidebar-icon-links">

  <a id="bluesky-link"
     class="icon" title="Bluesky" aria-label="Bluesky"
     href="https://bsky.app/profile/gregorriegler.com">
    <?xml version="1.0" encoding="UTF-8"?>
<svg width="24" height="21" viewBox="0 0 600 530" version="1.1" xmlns="http://www.w3.org/2000/svg">
 <path d="m135.72 44.03c66.496 49.921 138.02 151.14 164.28 205.46 26.262-54.316 97.782-155.54 164.28-205.46 47.98-36.021 125.72-63.892 125.72 24.795 0 17.712-10.155 148.79-16.111 170.07-20.703 73.984-96.144 92.854-163.25 81.433 117.3 19.964 147.14 86.092 82.697 152.22-122.39 125.59-175.91-31.511-189.63-71.766-2.514-7.3797-3.6904-10.832-3.7077-7.8964-0.0174-2.9357-1.1937 0.51669-3.7077 7.8964-13.714 40.255-67.233 197.36-189.63 71.766-64.444-66.128-34.605-132.26 82.697-152.22-67.108 11.421-142.55-7.4491-163.25-81.433-5.9562-21.282-16.111-152.36-16.111-170.07 0-88.687 77.742-60.816 125.72-24.795z"/>
</svg>

  </a>

  <a id="mastodon-link"
     class="icon" title="Mastodon" aria-label="Mastodon"
     href="https://fosstodon.org/@gregorriegler">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="26" viewBox="0 0 216.4144 232.00976">
  <defs>
    <mask id="mastodon-mask">
      <rect width="100%" height="100%" fill="white"/>
      <path d="M177.50984 80.077v60.94125h-24.14375v-59.15c0-12.46875-5.24625-18.7975-15.74-18.7975-11.6025 0-17.4175 7.5075-17.4175 22.3525v32.37625H96.20734V85.42325c0-14.845-5.81625-22.3525-17.41875-22.3525-10.49375 0-15.74 6.32875-15.74 18.7975v59.15H38.90484V80.077c0-12.455 3.17125-22.3525 9.54125-29.675 6.56875-7.3225 15.17125-11.07625 25.85-11.07625 12.355 0 21.71125 4.74875 27.8975 14.2475l6.01375 10.08125 6.015-10.08125c6.185-9.49875 15.54125-14.2475 27.8975-14.2475 10.6775 0 19.28 3.75375 25.85 11.07625 6.36875 7.3225 9.54 17.22 9.54 29.675" fill="black"/>
    </mask>
  </defs>
  <path d="M211.80734 139.0875c-3.18125 16.36625-28.4925 34.2775-57.5625 37.74875-15.15875 1.80875-30.08375 3.47125-45.99875 2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125 0 2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47 27.225 46.39125 27.9425 21.11625.7225 39.91875-5.20625 39.91875-5.20625l.8675 19.09s-14.77 7.93125-41.08125 9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23234 213.82 1.40609 165.31125.20859 116.09125c-.365-14.61375-.14-28.39375-.14-39.91875 0-50.33 32.97625-65.0825 32.97625-65.0825C49.67234 3.45375 78.20359.2425 107.86484 0h.72875c29.66125.2425 58.21125 3.45375 74.8375 11.09 0 0 32.975 14.7525 32.975 65.0825 0 0 .41375 37.13375-4.59875 62.915" mask="url(#mastodon-mask)"/>
</svg>

  </a>

  <a id="linkedin-link"
     class="icon" title="LinkedIn" aria-label="LinkedIn"
     href="https://www.linkedin.com/in/gregorriegler/">
    <?xml version="1.0" ?>
<svg height="24" viewBox="0 0 72 72" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M62,62 L51.315625,62 L51.315625,43.8021149 C51.315625,38.8127542 49.4197917,36.0245323 45.4707031,36.0245323 C41.1746094,36.0245323 38.9300781,38.9261103 38.9300781,43.8021149 L38.9300781,62 L28.6333333,62 L28.6333333,27.3333333 L38.9300781,27.3333333 L38.9300781,32.0029283 C38.9300781,32.0029283 42.0260417,26.2742151 49.3825521,26.2742151 C56.7356771,26.2742151 62,30.7644705 62,40.051212 L62,62 Z M16.349349,22.7940133 C12.8420573,22.7940133 10,19.9296567 10,16.3970067 C10,12.8643566 12.8420573,10 16.349349,10 C19.8566406,10 22.6970052,12.8643566 22.6970052,16.3970067 C22.6970052,19.9296567 19.8566406,22.7940133 16.349349,22.7940133 Z M11.0325521,62 L21.769401,62 L21.769401,27.3333333 L11.0325521,27.3333333 L11.0325521,62 Z"/>
</svg>
  </a>
  
  <a id="github-link"
     class="icon" title="Github" aria-label="Github"
     href="https://github.com/gregorriegler">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28" height="24" width="28"><path d="M12 2c6.625 0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-0.609 0.109-0.828-0.266-0.828-0.578 0-0.391 0.016-1.687 0.016-3.297 0-1.125-0.375-1.844-0.812-2.219 2.672-0.297 5.484-1.313 5.484-5.922 0-1.313-0.469-2.375-1.234-3.219 0.125-0.313 0.531-1.531-0.125-3.187-1-0.313-3.297 1.234-3.297 1.234-0.953-0.266-1.984-0.406-3-0.406s-2.047 0.141-3 0.406c0 0-2.297-1.547-3.297-1.234-0.656 1.656-0.25 2.875-0.125 3.187-0.766 0.844-1.234 1.906-1.234 3.219 0 4.594 2.797 5.625 5.469 5.922-0.344 0.313-0.656 0.844-0.766 1.609-0.688 0.313-2.438 0.844-3.484-1-0.656-1.141-1.844-1.234-1.844-1.234-1.172-0.016-0.078 0.734-0.078 0.734 0.781 0.359 1.328 1.75 1.328 1.75 0.703 2.141 4.047 1.422 4.047 1.422 0 1 0.016 1.937 0.016 2.234 0 0.313-0.219 0.688-0.828 0.578-4.766-1.594-8.203-6.094-8.203-11.391 0-6.625 5.375-12 12-12zM4.547 19.234c0.031-0.063-0.016-0.141-0.109-0.187-0.094-0.031-0.172-0.016-0.203 0.031-0.031 0.063 0.016 0.141 0.109 0.187 0.078 0.047 0.172 0.031 0.203-0.031zM5.031 19.766c0.063-0.047 0.047-0.156-0.031-0.25-0.078-0.078-0.187-0.109-0.25-0.047-0.063 0.047-0.047 0.156 0.031 0.25 0.078 0.078 0.187 0.109 0.25 0.047zM5.5 20.469c0.078-0.063 0.078-0.187 0-0.297-0.063-0.109-0.187-0.156-0.266-0.094-0.078 0.047-0.078 0.172 0 0.281s0.203 0.156 0.266 0.109zM6.156 21.125c0.063-0.063 0.031-0.203-0.063-0.297-0.109-0.109-0.25-0.125-0.313-0.047-0.078 0.063-0.047 0.203 0.063 0.297 0.109 0.109 0.25 0.125 0.313 0.047zM7.047 21.516c0.031-0.094-0.063-0.203-0.203-0.25-0.125-0.031-0.266 0.016-0.297 0.109s0.063 0.203 0.203 0.234c0.125 0.047 0.266 0 0.297-0.094zM8.031 21.594c0-0.109-0.125-0.187-0.266-0.172-0.141 0-0.25 0.078-0.25 0.172 0 0.109 0.109 0.187 0.266 0.172 0.141 0 0.25-0.078 0.25-0.172zM8.937 21.438c-0.016-0.094-0.141-0.156-0.281-0.141-0.141 0.031-0.234 0.125-0.219 0.234 0.016 0.094 0.141 0.156 0.281 0.125s0.234-0.125 0.219-0.219z"></path>
</svg>

  </a>

  <a id="youtube-link"
     class="icon" title="Youtube" aria-label="Youtube"
     href="https://www.youtube.com/channel/UCsWg_i6X4KMhjD2CRqCJLdg">
    <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="96.875px" height="96.875px" viewBox="0 0 96.875 96.875" style="enable-background:new 0 0 96.875 96.875;"
	 xml:space="preserve">
<g>
	<path d="M95.201,25.538c-1.186-5.152-5.4-8.953-10.473-9.52c-12.013-1.341-24.172-1.348-36.275-1.341
		c-12.105-0.007-24.266,0-36.279,1.341c-5.07,0.567-9.281,4.368-10.467,9.52C0.019,32.875,0,40.884,0,48.438
		C0,55.992,0,64,1.688,71.336c1.184,5.151,5.396,8.952,10.469,9.52c12.012,1.342,24.172,1.349,36.277,1.342
		c12.107,0.007,24.264,0,36.275-1.342c5.07-0.567,9.285-4.368,10.471-9.52c1.689-7.337,1.695-15.345,1.695-22.898
		C96.875,40.884,96.889,32.875,95.201,25.538z M35.936,63.474c0-10.716,0-21.32,0-32.037c10.267,5.357,20.466,10.678,30.798,16.068
		C56.434,52.847,46.23,58.136,35.936,63.474z"/>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
</svg>

  </a>

  <a id="goodreads-link"
     class="icon" title="goodreads" aria-label="goodreads"
     href="https://www.goodreads.com/user/show/22567057-gregor-riegler">
    <?xml version="1.0" ?><svg style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style type="text/css">
	.st0{}
	.st1{fill:#202020;}
</style><g id="Edges"/><g id="Background_1_"><path class="st0" d="M492,268.3c-6.3,122.8-109.9,224.4-236.5,224.5c-126.7,0.1-230.7-101.6-237-224.5   C11.7,136.2,119.6,19.2,255.2,19.2C390.9,19.2,498.7,136.3,492,268.3z"/></g><g id="Symbol"><path class="st1" d="M346.6,137.5c0-4.3-0.4-8.6-0.6-12.8c-9.2,0-16.9,0-25.6,0c0,9.8,0,18.9,0,28.1   c-41.1-57.3-125.6-39.2-149.4,17.9c-15.2,36.6-14.4,73.4,1.5,109.4c16.8,38,65,54.1,102.8,43.4c2-0.3,4.3-0.9,6.8-1.7   c3.6-1.1,6.7-2.5,8.7-3.6c5.2-2.1,11.4-5.6,17.5-10.3c4.9-3.8,9.1-7.8,12.4-11.5c-0.9,14.3-1.3,28.7-3.6,42.8   c-2.8,17.4-10.8,32.4-27.4,41.2c-36.2,19.2-79.6,4.6-96-32.4c-8.2,0-16.6,0-25.4,0c1.8,24.4,14.7,40.3,34.7,50.6   c24.1,12.4,49.9,13.7,76.2,9.4c33.5-5.5,55.3-24.4,63-57.8c2.7-11.9,4.2-24.2,4.3-36.4C346.8,255,346.6,196.2,346.6,137.5z    M316.5,260.3c-4.8,13.8-12.8,24.7-23.3,32.2c-2.6,1.9-15.4,10.8-34.1,11.7c-1.1,0.1-4.2,0.2-8,0c-0.1,0.1-0.3,0.1-0.4,0.1   c-27.3-1.7-48.2-17.6-57.4-43.9c-7.7-22.1-7.9-44.6-2.3-67.1c8.1-32.5,31.6-52.4,61.6-53.2c0.7-0.1,1.1-0.1,1.1-0.1   c15.6-1.4,27.8,5.1,31.6,7.2c16.1,8.6,28.2,24.6,33.5,46C324.4,215.7,324.2,238.2,316.5,260.3z"/></g></svg>
  </a>

  <a id="email-link"
     class="icon" title="e-mail" aria-label="e-mail"
     href="mailto:rieglerg85@gmail.com">
    <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Generator: Adobe Illustrator 18.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 493.332 493.332" style="enable-background:new 0 0 493.332 493.332;" xml:space="preserve">
<g id="XMLID_78_">
	<g id="XMLID_79_">
		<g id="XMLID_80_">
			<path id="XMLID_81_" d="M352.731,450.956c3.037,9.789-2.044,20.213-11.616,23.878c-35.811,13.709-69.294,18.498-112.873,18.498
				c-117.663,0-221.147-84.347-221.147-223.275C7.095,125.46,112.003,0,272.2,0c124.735,0,214.036,85.764,214.036,204.845
				c0,103.483-58.12,168.693-134.66,168.693c-33.327,0-57.419-17.007-60.955-54.582h-1.424c-21.963,36.15-53.86,54.582-91.43,54.582
				c-46.082,0-79.376-34.022-79.376-92.142c0-86.475,63.769-165.147,165.841-165.147c18.691,0,38.9,2.795,55.909,7.172
				c16.425,4.227,26.861,20.236,24.147,36.978l-16.972,104.695c-7.072,41.818-2.112,60.953,17.721,61.666
				c30.475,0.711,68.762-38.272,68.762-119.786c0-92.15-59.543-163.732-169.41-163.732c-108.444,0-203.428,85.051-203.428,220.436
				c0,118.369,75.834,185.708,181.448,185.708c27.489,0,56.203-4.51,80.853-13.214c5.863-2.07,12.315-1.662,17.872,1.126
				c5.558,2.788,9.753,7.716,11.595,13.655L352.731,450.956z M293.954,181.362c0.534-3.626-1.892-7.027-5.496-7.696
				c-4.413-0.819-9.536-1.426-15.573-1.426c-46.771,0-83.617,46.076-83.617,100.653c0,26.94,12.037,43.946,35.423,43.946
				c26.231,0,53.876-33.31,60.265-74.425L293.954,181.362z"/>
		</g>
	</g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
</svg>

  </a>

  <a id="subscribe-link"
     class="icon" title="Subscribe" aria-label="Subscribe"
     href="/feed.xml">
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>
  </a>

  
  
  
  

  

  

  <!-- Optional additional links to insert for icons links -->
</nav>

  <p class="license">
  <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0; margin: 0 0 .5rem" width="20" src="/assets/img/cc_icon_white_x2.png" /></a>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a> by <a href="http://gregorriegler.com">Gregor Riegler</a>.
  Layout: &copy; 2025.  <a href="/THEME_LICENSE.md">MIT License.</a>
</p>

</div>

    <main class="container">
      <div class="content">
  
  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/2021/07/02/tdd-crash-course-from-the-back-of-the-room.html">
        TDD Crash Course from the BACK of the Room
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">02 Jul 2021</span>
  <span class="post-categories">
    
  </span>
</div>


    
      <p>I was recently giving a 2 hour TDD crash course remotely for a group of 5 people, and I find it worked out wonderfully!
So I would like to share with you how I did it.</p>

<p><strong>If you were searching for TDD guidance, this is not it!
It is rather a guide on how to run a TDD crash course.</strong></p>

<p>I recently read the book <em><a href="https://www.goodreads.com/book/show/8141935-training-from-the-back-of-the-room">Training from the BACK of the Room!</a></em>, which resonated with me, and it inspired how I ran the course.
The book is highly innovative and turns traditional training upside down.
The emphasis is on learners being active and talking more during the training instead of the teacher.</p>

<h2 id="the-training-plan">The Training Plan</h2>

<h3 id="goal">Goal</h3>
<p>The goal of this training is for participants to understand TDD and be able to practice the red-green-refactor cycle themselves.
It is not a goal of this training to make TDD pros that can test drive their whole projects.
While TDD is easy to start with, it is also hard to master.
To get better, learners will need much more hands-on practice after the training.
The course should provide participants with a smooth start on their learning journey.</p>

<h3 id="mode">Mode</h3>
<p>I did it remotely. 
However, I don’t see a reason why it would not work in the same way locally.</p>

<h3 id="group-size">Group Size</h3>
<p>5-6 Participants.</p>

<h3 id="principles">Principles</h3>
<p>Knowing the principles I used for this training will help you understand the reasoning behind its design.</p>

<ul>
  <li>
    <p><strong>Just show up.</strong>
 Coding sessions often require technical preparations for participants in advance. 
 When the training starts, you somehow lose those 25 minutes to fix the issues every time.
 Two hours is not enough time for having this kind of technical troubleshooting.
 So for this training, there is no preparation for participants needed.
 All participants have to do is to show up.</p>
  </li>
  <li>
    <p><strong>Focus on the need to knows.</strong>
 TDD is a broad topic, but the essentials are few.
 Teaching everything from history to styles, test doubles, and so on would merely confuse the learners.
 So in this training, we focus only on the essentials.</p>
  </li>
  <li>
    <p><strong><a href="https://en.wikipedia.org/wiki/Learning-by-doing">Learning by doing</a>.</strong>
 The training will have the participants experience TDD in practice, which is very important.
 We could explain what a <a href="http://www.thinkcode.se/blog/2019/05/18/what-is-the-size-of-a-baby-step">baby step</a> is and what the value of a fast test suite is.
 Still, learners won’t understand unless they experience it themselves.</p>
  </li>
  <li>
    <p><strong>Have learners talk the most.</strong>
 In traditional training, the trainer talks more than 70% of the time, which doesn’t help learners learn.
 Participants learn much more effectively when they are the ones talking.
 So this training aims at maximizing the amount of time that learners talk instead of the trainer.</p>
  </li>
  <li>
    <p><strong>Keep everybody engaged from start to finish.</strong>
 No participant should be listening passively for more than 10 minutes at a time. 
 We want to keep them engaged to get the most out of their training.</p>
  </li>
  <li>
    <p><strong>The <a href="https://trainingindustry.com/articles/content-development/facilitating-according-to-the-10-minute-rule/">10-minute rule</a>.</strong>
 The 10-minute rule helps us to optimize for the approximate attention span of people.
 TV has conditioned us to receive information in small segments of ~10 minutes in length.
 After 10 to 20 minutes, learning begins to diminish.
 So we want to avoid dry instruction that lasts longer than that.</p>
  </li>
  <li>
    <p><strong><a href="https://en.wikipedia.org/wiki/Psychological_safety">Psychological safety</a>.</strong>
 Create an environment where participants feel comfortable to express their opinions without the fear of being wrong.
 We don’t want them to be afraid of making mistakes, so we don’t punish those.
 Instead, reward every form of contribution from the very beginning.
 Whatever learners have to say: Unless it’s not abusive, it’s not wrong - it’s interesting.</p>
  </li>
</ul>

<h3 id="start-up">Start-Up</h3>
<p>Two hours is not a lot of time.
If the group already knows each other, we want to jump right into the topic.
When that’s not the case, give them at least the opportunity to introduce themselves in a minute or two.
I like to use one of the following Start-Up activities.</p>

<h4 id="start-up-activity-web-hunt-20-30-minutes">Start-Up Activity: Web Hunt (20-30 minutes)</h4>
<p>Start with a “Web Hunt” activity where learners have 10 minutes to search the web and find three facts and come up with one question they have about TDD. 
Prepare a virtual board where the learners can put and share their findings.</p>

<p>Then, take another ~10 minutes to review the facts and questions they had put on the board.
Have the participants present them, and try to stay out of the discussion as much as possible.
When you are not satisfied with one of the facts, ask the other participants what they think about it.
Try to have the learners answer all the questions on the board.
If you have some great answers that you can back up with quality content such as links to blog posts, articles, talks, or books - that’s awesome.
Add those in the end.</p>

<p>Keep in mind that it’s not about us (the trainers). It’s about the learners.</p>

<h4 id="alternative-start-up-activity-what-do-you-already-know-20-30-minutes">Alternative Start-Up Activity: What do you already know? (20-30 minutes)</h4>
<p>Give learners 10 minutes to think of three facts they already know about TDD and have them put those on a virtual board for everybody to see.
Then, take another ~10 minutes to have participants present the facts they had put on the board.
When you are not satisfied with one of the facts, ask the other participants what they think about it.
This activity connects learners to the things they already know.
Typically, developers have already heard at least something about the topic.
When they connect to these things first, it will help them evaluate what they had learned in the training.</p>

<h3 id="theory-10-minutes">Theory (10 minutes)</h3>
<p>After that comes the only part of the training that is dry instruction.
Take ten quick minutes to explain the essentials of the TDD workflow.
The <a href="http://butunclebob.com/ArticleS.UncleBob.TheThreeRulesOfTdd">three rules of TDD</a> provide a good start, but you probably want to explain the whole workflow.
This <a href="https://wiki.c2.com/?TestDrivenDevelopment">wiki page</a> gives a nice overview of all the steps involved.</p>

<h3 id="short-break-10-minutes">Short Break (10 minutes)</h3>
<p>At this point, we are typically 30-40 minutes into the training, and it’s an opportunity to have a 10-minute break.
After that, continue with the practical coding part.</p>

<h3 id="practical-fizzbuzz-60-minutes">Practical FizzBuzz (60 minutes)</h3>
<p>The kata I choose for this exercise is <a href="https://kata-log.rocks/fizz-buzz-kata">FizzBuzz</a>, as it is pretty simple and can be completed within the available time.
It should help with creating the feeling of having accomplished something which makes the learning stick longer.
Also, we don’t want to confuse learners with a design challenge.
That’s not the focus here.
The focus is on the TDD workflow and the thought process and decision-making behind it. 
A bit of sugar on top is the opportunity to use a <a href="https://www.petrikainulainen.net/programming/testing/junit-5-tutorial-writing-parameterized-tests/">parameterized test</a>, which learners often find interesting.
The kata is being worked on in a special <a href="https://mobprogramming.org/mob-programming-basics/">mob</a> where everybody is assigned a specific role.</p>

<h4 id="roles-red--green--blue--navigator">Roles: Red / Green / Blue / Navigator</h4>
<p>As we like to keep all participants engaged, we assign each a responsibility that requires them to stay focused. Choose three people and assign them one of these referee roles:</p>

<ul>
  <li><strong>Red Referee</strong>: This role is responsible to make sure we watch each test fail and that the error presented is useful and expressive.</li>
  <li><strong>Green Referee</strong>: Watches out that we only write the simplest code to fulfill the test, but not the line of code we know we’d need to write.</li>
  <li><strong>Refactor Referee</strong>: Makes sure we always refactor in the green and only in the green.</li>
</ul>

<p>The other participants are navigating collaboratively. Take a look at <a href="https://llewellynfalco.blogspot.com/2014/06/llewellyns-strong-style-pairing.html">strong style pairing</a> to understand the Driver/Navigator relationship.</p>

<p>After half-time, ask your participants whether they would like to rotate their roles.</p>

<h4 id="the-trainer-is-the-driver">The Trainer is the Driver</h4>
<p>The trainer is the Driver/Typist.
Writing down test cases is another important exercise for learners, but it is not the focus of this training.
The focus of this training is to have learners grok the workflow of TDD. 
To learn the decisions we make, when we have tests drive our design in tiny steps.
And to achieve that, we would like to remove all other impediments.
So the trainer plays the smart input device that makes it easy for the learners to write the tests they want.
As a driver, the trainer is also able to step in and take control if needed.</p>

<p>The trainer shares their screen, test setup prepared with the FizzBuzz requirements as a comment on the dummy test, font size increased, and test result visible.
Remember, the goal of the trainer is to stay in the background as much as possible.
She might chime in to get things going but mostly asks the right questions and delegates control to the participants.</p>

<p>As a trainer, you might say: “I only type when you navigators tell me to.”,
or: “What would be an even simpler test case to start with?”
When you see something you are not satisfied with, play the ball to the responsible referee: “Green referee, what do you have to say about this?”,
“Refactor referee, Is it okay that we do this refactoring now?”</p>

<p>Instruct participants to have their mics on!
Sometimes people turn their mics off when they are in video calls which could be harmful in this training.
When everybody is starring at the code, we won’t notice when somebody starts talking with their mic off.</p>

<h3 id="retrospective-10-20-minutes">Retrospective (10-20 minutes)</h3>
<p>Find out what the participants have learned that they hadn’t known before.
How did they feel doing FizzBuzz using TDD?
Was there anything they didn’t like?
Ask the participants whether they would want to apply it in their real projects and how.
They are more likely to do so, when they commit to it publicly.</p>

<h2 id="conclusion">Conclusion</h2>
<p>It’s astonishing how much you can still teach after getting out of the way.
Of course, the crash course is just the start for the learners. 
It will provide them with the prerequisites to have more hands-on practice.
After the training, they should feel more comfortable joining a dojo/code retreat.</p>

<p>Did you like the training design? 
Which parts did you not like?
How are you teaching TDD?
Leave me a comment.</p>

    

    
      
      
      

      
    

    <p><br class="clear" /><a class="comments_link" href="/2021/07/02/tdd-crash-course-from-the-back-of-the-room.html#comments">to the comments</a></p>
  </article>
  
  
  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/2021/05/20/why-test.html">
        Why Test?
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">20 May 2021</span>
  <span class="post-categories">
    
  </span>
</div>


    
      <p>It’s 2021, yet developers writing automated tests don’t seem to be the norm to this day.
The belief that the writing of tests is just an additional effort that increases development cost is still going strong. 
Of course, it’s wrong.</p>

<p>Yes, the learning curve is steep, and yes, there’s a lot of things to get wrong and to suffer from.
Proper developer testing like TDD is a broad topic and demands deep knowledge of design and refactoring.
None of which seem to be taught in higher technical schools that much either.
Humans have been developing software without writing tests for decades, so why bother?</p>

<p>Well, I write tests to my own advantage.
I do it so that I know what I’m doing, early and often. 
It helps me find more joy at work and has an overall positive impact on how I feel.
Maybe also because I’m a little lazy.</p>

<p>Hopefully, this little diagram will help explain how this works out for me.</p>

<p><img src="/assets/why-test/why-test.png" alt="How good developer tests are advantageous" /></p>

    

    
      
      
      

      
    

    <p><br class="clear" /><a class="comments_link" href="/2021/05/20/why-test.html#comments">to the comments</a></p>
  </article>
  
  
  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/2020/11/30/peeling-an-onion.html">
        Peeling an Onion
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">30 Nov 2020</span>
  <span class="post-categories">
    
  </span>
</div>


    
      <p>In one of the recent Coderetreats, we did an Outside-In TDD session. I paired with a guy who was new to this, and I noticed a challenge in expressing my ideas well. Honestly, I don’t think I did a good job, so I decided to write about this topic.</p>

<h2 id="a-software-system">A Software System</h2>

<p>Suppose we’re developing a thing, a program.</p>

<center><img src="/assets/peeling-an-onion/system.png" style="zoom: 33%;" /></center>

<p>It will inevitably become a hierarchical system composed of collaborators that form the sub- and sub-sub systems. 
Each of those will solve yet another problem, and together they will form our thing.
The outer layers will be more concerned with infrastructure and coordination, whereas the inner parts will be concerned with the business logic, the domain.</p>

<h2 id="outside-vs-inside">Outside vs Inside</h2>

<p>When we design the thing we can start on either side, the outside or the inside.</p>

<center><img src="/assets/peeling-an-onion/outside-inside.png" style="zoom:33%;" /></center>

<h3 id="the-outside">The Outside</h3>

<p>The outside is where the users of the thing are. 
Users might not just be humans, but also other software systems.
They observe the thing from the outside, and they cannot see inside of it. 
But they don’t even care about its inside. 
All they’re interested in is what it does, and how to interact with it.</p>

<p>So to them, it is a black box.</p>

<center><img src="/assets/peeling-an-onion/blackbox.png" style="zoom:50%;" /></center>

<h3 id="the-inside">The Inside</h3>

<p>The inside contains the hidden details of the thing - its gear, its structure.
It represents all the subproblems the thing was broken into. 
The inside answers the question, <em>how</em> the thing accomplishes what it was designed for.</p>

<h2 id="inside-out-design">Inside-Out Design</h2>

<p>In Inside-Out Design we start at the inside and gradually ascend outwards.
So we first break the problem down into smaller subproblems and define how they interact with each other. 
In doing so we identify the most inner pieces, the domain of the system.
Doing Inside-Out, they are exactly where we want to start.
After all, they will be the foundation for the remainder of the system.
They are the collaborators we use as soon as we ascend to build the next higher layer. 
As we ascend further and further outside we will at one point arrive at the outermost layers. 
They form the interface of our system, the entry point users may interact with.
As we build those last, they will be guided by the structure and behavior of the subsystems that have already been built.
So they will be biased towards the early decisions we made when we first designed the domain. 
I think that a good example of an API that is biased towards its domain is the CLI of git. You see that in the sophisticated helper <a href="https://gitless.com/">tools</a>, <a href="https://github.com/tj/git-extras">scripts</a> and <a href="https://github.com/ohmyzsh/ohmyzsh/wiki/Cheatsheet#git">aliases</a> that attempt to make it more accessible.</p>

<blockquote>
  <p>ⓘ Inside-Out is domain-centric. Can cause the Interface to be biased towards early domain decisions.</p>

  <p>Stereotypes:</p>

  <ul>
    <li>
      <p>We cannot know what the domain will look like in advance, it is shaped by how users will want to use the system.</p>
    </li>
    <li>
      <p>A bias towards the domain makes the interface more complicated.</p>
    </li>
    <li>
      <p>To preserve a sound Interface, we might have to make ugly adjustments in the layers above the domain.</p>
    </li>
    <li>
      <p>Thinking about usage last will cause us to build features nobody will ever use. (YAGNI<sup id="fnref:YAGNI"><a href="#fn:YAGNI" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>)</p>

    </li>
  </ul>
</blockquote>

<h2 id="outside-in-design">Outside-In Design</h2>

<p>When we start from the outside we don’t care about the domain at first. 
Instead, we focus on the users and how they would want to use the thing.
So we imagine the thing as a black box while defining its interface as simple and practical as possible.
It will be doing what it should do, but we will care about that later.</p>

<p>Once the interface is defined we descend inwards, thinking about how we can bring this entry point to life.
Now we have to decide what collaborators will be needed, and what their responsibilities will be.
So from this perspective, the entry point we just defined is now the new user.
Again, we’re treating its collaborators as black boxes. 
And again, at first, we only care about what they do, but not <em>how</em>.</p>

<center><img src="/assets/peeling-an-onion/descending.png" style="zoom:33%;" /></center>

<p>We descend further until we arrive at the core, the domain.</p>

<center><img src="/assets/peeling-an-onion/descending_2.png" style="zoom:60%;" /></center>

<p>As a result, the built system will be biased towards the anticipated usage of the thing.</p>

<blockquote>
  <p>ⓘ Outside-In is user-centric. The implemented solution might be biased towards the anticipated usage.</p>

  <p>Stereotypes:</p>

  <ul>
    <li>We’re bad at predicting how users will want to use the system.</li>
    <li>A bias towards usage makes the domain unnecessarily complicated.</li>
    <li>Thinking about usage first will help us avoid building stuff we don’t need. (YAGNI<sup id="fnref:YAGNI:1"><a href="#fn:YAGNI" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>)</li>
  </ul>
</blockquote>

<h2 id="descending-in-outside-in-tdd">Descending in Outside-In TDD</h2>

<p>When we test drive the thing Outside-In, we may start with an acceptance test as in <a href="http://coding-is-like-cooking.info/2013/04/outside-in-development-with-double-loop-tdd/">double loop TDD</a>. 
It describes the thing and its interface in a simple example: How it is used, and what it does. 
Of course, the test does not work, as there is no <em>thing</em> yet. 
We can now keep the test red until it passes, or we just disable it.
But our goal is to make it pass.
So we write another - this time a unit test, to guide us towards writing the code that will make the acceptance test pass.</p>

<p>And this is already the first of three descending strategies which I call: <strong>“Skip and Descend”</strong>.
The other two are <strong>“Fake it till you make it”</strong>, and <strong>“Replace with Test Double”</strong>.
But when we build a full slice from the entry point all the way down to the domain, we mostly don’t use just one strategy, but a combination of these. 
Every time we descend we have to make another judgment call about which strategy fits best this time.</p>

<h3 id="skip-and-descend">Skip and Descend</h3>

<p>In Skip and Descend we use a test to drive the decision which immediate collaborators will be needed to suffice the test.
But we acknowledge the fact that implementing those collaborators on the basis of this test would be too big of a step. 
So we disable the test and descend to start test driving the just defined collaborator.
Sometimes we may rinse and repeat until we arrive at a leaf whose unit is small enough to be implemented.
After implementing the leaf we would ascend again to the previously disabled test where we would then use the collaborator we just built.
Kind of like mikado.</p>

<p>Leads to <a href="https://martinfowler.com/bliki/UnitTest.html">sociable unit tests</a> and test overlap<sup id="fnref:TestOverlap"><a href="#fn:TestOverlap" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>.
Where test overlap happens we aim to minimize it and use the sociable unit tests to cover integrations only.</p>

<h4 id="use-when">Use when</h4>

<ul>
  <li>Confident in the need of the collaborator.</li>
  <li>The sociable unit test will be fast:
    <ul>
      <li>The collaborator is doing in-memory instructions that finish within milliseconds.</li>
      <li>The collaborator is going to be a <a href="http://xunitpatterns.com/Fake%20Object.html">fake</a> that will be replaced by a real system later.</li>
      <li>The collaborator is inside the application boundary.</li>
      <li>The collaborator is not interacting with an expensive system such as a database or a web service.</li>
    </ul>
  </li>
  <li>The call to the collaborator is not a notification<sup id="fnref:Notification"><a href="#fn:Notification" class="footnote" rel="footnote" role="doc-noteref">3</a></sup>.</li>
</ul>

<h4 id="advantages">Advantages</h4>

<ul>
  <li>Avoids test doubles<sup id="fnref:TestDouble"><a href="#fn:TestDouble" class="footnote" rel="footnote" role="doc-noteref">4</a></sup>, and as such decouples the tests from their implementation to enable refactoring<sup id="fnref:StructureInsensitive"><a href="#fn:StructureInsensitive" class="footnote" rel="footnote" role="doc-noteref">5</a></sup>.</li>
</ul>

<h4 id="disadvantages">Disadvantages</h4>

<ul>
  <li>Need to manage disabled tests.</li>
  <li>Can lead to premature collaborators.</li>
</ul>

<h3 id="fake-it-till-you-make-it">Fake it till you make it</h3>

<p>In fake it till you make it we don’t necessarily decide on a collaborator and descend.
Instead, we write the simplest and stupidest expression that will make the current test pass.
We then write more tests to force us to change the stupid and specific expression into something more generic.
We might have to apply <a href="https://martinfowler.com/articles/preparatory-refactoring-example.html">preparatory refactorings</a> in the process.
With those, we place seeds as we extract new collaborators that grow while we write and pass more tests.
May also lead to sociable unit tests and test overlap.</p>

<h4 id="use-when-1">Use when</h4>

<ul>
  <li>Unsure which collaborators to create at first.</li>
  <li>The <a href="http://xunitpatterns.com/SUT.html">SUT (System Under Test)</a> remains inside the application boundary.</li>
  <li>The SUT is not interacting with an expensive system such as a database or a web service.</li>
  <li>The call to the collaborator is not a notification.</li>
</ul>

<h4 id="advantages-1">Advantages</h4>

<ul>
  <li>Avoids test doubles<sup id="fnref:TestDouble:1"><a href="#fn:TestDouble" class="footnote" rel="footnote" role="doc-noteref">4</a></sup>, and as such decouples the tests from their implementation to enable refactoring<sup id="fnref:StructureInsensitive:1"><a href="#fn:StructureInsensitive" class="footnote" rel="footnote" role="doc-noteref">5</a></sup>.</li>
  <li>Collaborators emerge out of <a href="https://www.devteams.at/red_green/2019/04/08/red_green_part_6_triangulation.html">triangulation</a> and are therefore more mature.</li>
</ul>

<h4 id="disadvantages-1">Disadvantages</h4>

<ul>
  <li>Testing subcollaborators from a distance.</li>
</ul>

<h3 id="replace-with-test-double">Replace with Test Double<sup id="fnref:TestDouble:2"><a href="#fn:TestDouble" class="footnote" rel="footnote" role="doc-noteref">4</a></sup></h3>

<p>When we are confident in the need of a collaborator, we may decide on replacing it with a test double.
This allows us to finish the implementation of the current SUT before having to descend.</p>

<h4 id="use-when-2">Use when</h4>

<ul>
  <li>Confident in the need of the collaborator.</li>
  <li>The collaborator is at the application boundary.</li>
  <li>The collaborator is at the boundary of the module.</li>
  <li>The collaborator interacts with an expensive subsystem such as a database or a web service.</li>
  <li>The call to the collaborator is a notification; we like to use a mock in this case.</li>
</ul>

<h4 id="advantages-2">Advantages</h4>

<ul>
  <li>Avoids test-overlap.</li>
  <li>Can finish the SUT before having to descend.</li>
  <li>Allows simulating expensive subsystems such as databases and web services.</li>
</ul>

<h4 id="disadvantages-2">Disadvantages</h4>

<ul>
  <li>Couples the structure of the test to the structure of the implementation.</li>
  <li>Mocks typically less performant than hand-written test doubles.</li>
  <li>Hand-written test doubles are an additional effort to write.</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>Mocks are not the only way to descend in Outside-In TDD. 
There are many strategies, each of which has different trade-offs. 
So we have to make a judgment call every time.
We need to keep an eye on refactorability when writing our tests. 
Sociable unit tests can improve refactorability, but we have to keep the test-overlap low. 
So we avoid testing all the details from a distance.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:YAGNI">
      <p><a href="https://martinfowler.com/bliki/Yagni.html">You Aint Gonna Need It</a> <a href="#fnref:YAGNI" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:YAGNI:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:TestOverlap">
      <p>Test overlap is when more than one unit tests cover the same thing thus may fail for the same reason. <a href="#fnref:TestOverlap" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:Notification">
      <p>A Notification a.k.a ‘fire and forget’ is a type of relationship between objects where one object just notifies another. I first read the Term in the <a href="http://www.growing-object-oriented-software.com/">GOOS Book</a>. To test notifications we prefer to use mocks or spies. <a href="#fnref:Notification" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:TestDouble">
      <p>A <a href="http://xunitpatterns.com/Test%20Double.html">test touble</a> replaces a real collaborator in a unit test, just as a stunt double replaces the real actor in a scene <a href="#fnref:TestDouble" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:TestDouble:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a> <a href="#fnref:TestDouble:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a></p>
    </li>
    <li id="fn:StructureInsensitive">
      <p>Tests should be <a href="https://www.youtube.com/watch?v=bvRRbWbQwDU">structure insensitive</a> to enable refactoring. <a href="#fnref:StructureInsensitive" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:StructureInsensitive:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
  </ol>
</div>

    

    
      
      
      

      
    

    <p><br class="clear" /><a class="comments_link" href="/2020/11/30/peeling-an-onion.html#comments">to the comments</a></p>
  </article>
  
  
  
  
  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/2020/08/08/levels-of-modularity.html">
        Levels of Modularity
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">08 Aug 2020</span>
  <span class="post-categories">
    
  </span>
</div>


    
      <p><a href="https://code-cop.org/">Peter &lt;Code Cop&gt; Kofler</a> and I recently facilitated a refactoring workshop where we guided our participants to incrementally extract a microservice from a monolith. Similar workshops were mostly about the technology side of things and neglected the coding part which we found was sad. So we obviously decided to focus on <strong>hands on coding</strong> and to practice the refactoring steps needed for this task.</p>

<p>We identified several milestones in this refactoring exercise which we then laid out as the <strong>‘Levels of Modularity’</strong>.
Each level represents a different kind of architecture that shows stronger or weaker modularity.</p>

<p>The model helps us to reason about our current architecture and decide where we want to go.
But most interestingly it acts as a play book how to extract a microservice.
It is feasible to go through each level and gradually increase the modularity in an attempt to extract the microservice.</p>

<h2 id="modularity-is-about-controlling-the-scope-of-change">Modularity is about controlling the scope of change</h2>
<p>Modularity is the property of a system to which degree it is composed of modules. 
Modularity is recursive - Modules may be further decomposed into submodules.
A module is a cohesive, loosely coupled, encapsulated and composable piece of software that does one thing.<br />
I don’t see modularity and its characteristics as absolutes. 
I rather see nuances and trade offs.
But it is all about controlling the scope of change.</p>

<ul>
  <li>Cohesion tells whether code that changes for the same reason, is put closely. We aim for high cohesion.</li>
  <li>Coupling tells to which degree a change in one part of the system affects another. 
Usually we aim for loose coupling so that we can change things independently. 
But the decoupling may come with a burden, which forces us to make trade offs. 
So we like to find the sweet spot.</li>
</ul>

<h2 id="level--1-the-distributed-monolith">Level -1: The Distributed Monolith</h2>

<p><img src="/assets/modularity/modularity_level99_distributed_monolith.svg" alt="Distributed Monolith" width="25%" class="textwrap" /></p>

<div class="table-wrapper">

  <table>
    <thead>
      <tr>
        <th style="text-align: left">Drawing</th>
        <th>What it means</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="text-align: left">Grey Box with Black Border</td>
        <td>The Unit of Deployment</td>
      </tr>
      <tr>
        <td style="text-align: left">Colored Circles</td>
        <td>This is Code. The Color represents what the Code is doing work for. Every Color signifies another Feature / Behaviour.</td>
      </tr>
      <tr>
        <td style="text-align: left">Lines connecting Things</td>
        <td>Dependencies</td>
      </tr>
    </tbody>
  </table>

</div>

<p>The structure tells that there has been an attempt to decompose the system into services.
But what it apparently does is it tears apart cohesive pieces of software and puts thick walls between them. 
None of the parts is able to perform useful work on its own. They have a strong coupling with their dependencies. 
<em>Shotgun Surgery<sup id="fnref:ShotgunSurgery"><a href="#fn:ShotgunSurgery" class="footnote" rel="footnote" role="doc-noteref">1</a></sup></em> is the result. 
One has to touch many services when changing a single feature.
Another effect is that it’s mostly impossible to deploy any of those services independently.</p>

<p>I put this even below level 0, as i see negative modularity going on. 
In an attempt to increase its modularity we would first have to join the services again, only to arrive at level 0.</p>

<p>How did we get there?</p>
<ul>
  <li>We just didn’t understand how to properly decompose a system into modules.</li>
  <li>We drew the boundaries before we had a proper understanding of the domain we’re building.</li>
  <li>There are different developers working on different layers of the same thing. (<em>Conways Law<sup id="fnref:ConwaysLaw"><a href="#fn:ConwaysLaw" class="footnote" rel="footnote" role="doc-noteref">2</a></sup></em>)</li>
</ul>

<h2 id="level-0">Level 0</h2>

<p>Monoliths with low cohesion and high coupling.</p>

<h3 id="level-0-the-big-ball-of-mud">Level 0: The Big Ball of Mud</h3>

<p><img src="/assets/modularity/modularity_level0.svg" alt="The Big Ball of Mud" width="25%" class="textwrap" /></p>

<p>This animal is completely disorganized. There is no recognizable structure, no abstraction, dependencies are intertwined. 
Strong coupling is the result. Changes in one area of the code lead to bugs in several other areas. 
It contains all sorts of <em>Code Smells<sup id="fnref:CodeSmell"><a href="#fn:CodeSmell" class="footnote" rel="footnote" role="doc-noteref">3</a></sup></em> from <em>God Classes</em> to <em>Feature Envy</em>, <em>Dead Code</em> and <em>Change Preventers</em>.</p>

<p>Developers get there because of many reasons:</p>
<ul>
  <li>Lack of Experience</li>
  <li>Carelessness after feeling treated unfair</li>
  <li>Rushing Changes to try and meet a deadline</li>
  <li>Developers with different views working independently on the same codebase without sufficient alignment.</li>
  <li>Fluctuation</li>
</ul>

<h3 id="level-0-monolith-packaged-by-layer">Level 0: Monolith packaged by Layer</h3>

<p><img src="/assets/modularity/modularity_level0_layered.svg" alt="Monolith packaged by Layer" width="25%" class="textwrap" /></p>

<p>This is probably the most common monolith out there. 
Its package structure is often guided by frameworks and code generators that propose having packages like <code class="language-plaintext highlighter-rouge">controllers</code>, <code class="language-plaintext highlighter-rouge">domain</code> and <code class="language-plaintext highlighter-rouge">repositories</code> on the top level. 
This framing proposes <em>Separation of Concerns<sup id="fnref:SeparationOfConcerns"><a href="#fn:SeparationOfConcerns" class="footnote" rel="footnote" role="doc-noteref">4</a></sup></em> which is a good thing. 
But the proposed way of having those packages on the top level obfuscates what the application is doing. “Controllers” does not provide any clue about what the app is doing.</p>

<h2 id="level-1">Level 1</h2>

<p>Monoliths with high cohesion.</p>

<h3 id="level-1-package-by-feature">Level 1: Package by Feature</h3>

<p><img src="/assets/modularity/modularity_level1.svg" alt="Package by Feature" width="25%" class="textwrap" /></p>

<p>Package by Feature is much more desirable. 
It puts the names of features like Order, Cart and User at the top level which are screaming<sup id="fnref:ScreamingArchitecture"><a href="#fn:ScreamingArchitecture" class="footnote" rel="footnote" role="doc-noteref">5</a></sup>: “I am a Shop!”.
It helps us to quickly find the code we need to change. 
As the cohesion is increased, we typically just have to touch a single top level package when changing a feature. 
There is no <em>information hiding<sup id="fnref:InformationHiding"><a href="#fn:InformationHiding" class="footnote" rel="footnote" role="doc-noteref">6</a></sup></em> going on between the features though. 
A code within one feature knows about the internals of another feature and has access to it. 
For Example: Feature A may fetch data from the Repository of Feature B, or use its business logic. 
So there is still coupling going on.</p>

<h3 id="level-1-features-but-layered-inside">Level 1: Features, but layered inside</h3>

<p><img src="/assets/modularity/modularity_level1_layered.svg" alt="Features, but layered inside" width="25%" class="textwrap" /></p>

<p><em>Separation of Concerns</em><sup id="fnref:SeparationOfConcerns:1"><a href="#fn:SeparationOfConcerns" class="footnote" rel="footnote" role="doc-noteref">4</a></sup> again, just inside feature packages.
We do this when we want to isolate our domain, our <em>Happy Zone<sup id="fnref:UniversalArchitecture"><a href="#fn:UniversalArchitecture" class="footnote" rel="footnote" role="doc-noteref">7</a></sup></em> from infrastructure code.
Or maybe we just like to organize our many files and put them into distinct folders to gain a better understanding of what a file is about.</p>

<h2 id="level-2-the-modular-monolith">Level 2: The Modular Monolith</h2>

<p><img src="/assets/modularity/modularity_level2.svg" alt="The Modular Monolith" width="25%" class="textwrap" /></p>

<p>A Monolith with both low coupling and high cohesion.</p>

<p>Feature packages turn modules. 
Each module now has a clear api which is the only way to access it. 
One module doesn’t know about the inner details of another module anymore. 
So they are encapsulated, and the coupling is further reduced. 
But as the module does not encapsulate its data, the modules are still coupled by the shared database.</p>

<p>Increasing the modularity further than this may come with a significant cost.</p>

<h2 id="level-3-the-microservice-ready-monolith">Level 3: The Microservice Ready Monolith</h2>

<p><img src="/assets/modularity/modularity_level3.svg" alt="The Microservice Ready Monolith" width="25%" class="textwrap" /></p>

<p>The coupling of a shared database is removed. 
Each module now uses its own data. 
Could be a separate database, or just separate tables within the same database. 
As long as there is no hidden coupling like a foreign key, we consider it as separated.
Sometimes, two or more modules need to access the same data.
In this case they would access the data through the module that owns it, or have a separate copy of the data.
In case of a copy we would choose a data model that perfectly fits the needs of the respective module. 
The data might be updated through events.</p>

<p>It’s still a monolith, but a very decoupled one. 
Extracting a microservice is very easy from this level.</p>

<h2 id="level-4-microservices">Level 4: Microservices</h2>

<p><img src="/assets/modularity/modularity_level4_microservice.svg" alt="Microservices" width="25%" class="textwrap" /></p>

<p>We can now deploy, as well as scale each service independently.
Each microservice has a strong autonomy and can be developed by its own team that uses the tech that best fits the services job.</p>

<p>But it comes at a cost and a lot of pain:</p>
<ul>
  <li>Hard to Integrate.</li>
  <li>Hard to Maintain.</li>
  <li>An organizational challenge.</li>
  <li>Lot’s of additional Technology might be needed.
    <ul>
      <li>API Gateway</li>
      <li>Event Bus</li>
      <li>Container Orchestration</li>
      <li>Configuration Broker</li>
      <li>Contract Testing</li>
      <li>Bulkheads</li>
      <li>Circuit Breakers</li>
      <li>Distributed Tracing</li>
      <li>Distributed Logging</li>
      <li>Service Registry</li>
      <li>and so on</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>“Don’t even consider microservices unless you have a system that’s too complex to manage as a monolith.”</p>

  <p>~Martin Fowler</p>
</blockquote>

<h2 id="conclusion">Conclusion</h2>

<p>The <strong>Levels of Modularity</strong> provide a model to reason about an architecture and help decide on where you want to go. 
The higher the level, the more modular an architecture is.</p>

<p>Also, we may use the <strong>Levels of Modularity</strong> as a cook book to refactor to a more modular architecture. 
We want to go level by level incrementally.</p>

<p>To get from a <em>Big Ball of Mud (Level 0)</em> to a <em>Modular Monolith (Level 2)</em>, we first want to find the features and collect them in distinct packages to arrive at <em>Package by Feature (Level 1)</em>. 
Only then would we decouple the feature packages to finally arrive at a <em>Modular Monolith (Level 2)</em>. 
We may even apply the <em>Strangler Pattern<sup id="fnref:StranglerPattern"><a href="#fn:StranglerPattern" class="footnote" rel="footnote" role="doc-noteref">8</a></sup></em> and carry one feature at a time through all levels.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:ShotgunSurgery">
      <p><a href="https://refactoring.guru/smells/shotgun-surgery">Shotgun Surgery</a>: A design smell where one has to make lot’s of changes in various places to change a single feature. <a href="#fnref:ShotgunSurgery" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:ConwaysLaw">
      <p><a href="https://en.wikipedia.org/wiki/Conway%27s_law">Conways Law</a>: Any organization that designs a system (defined broadly) will produce a design whose structure is a copy of the organization’s communication structure. <a href="#fnref:ConwaysLaw" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:CodeSmell">
      <p><a href="https://sourcemaking.com/refactoring/smells">Code Smell</a>: A sign that something might be wrong with the code. <a href="#fnref:CodeSmell" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:SeparationOfConcerns">
      <p><a href="https://wiki.c2.com/?SeparationOfConcerns">Separation Of Concerns</a> is a principle that proposes to separate code by its responsibilities. <a href="#fnref:SeparationOfConcerns" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:SeparationOfConcerns:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
    <li id="fn:ScreamingArchitecture">
      <p><a href="http://blog.cleancoder.com/uncle-bob/2011/09/30/Screaming-Architecture.html">Screaming Architecture</a> is an architecture that focuses on expressiveness, telling a developer what the code is doing from just looking at the top level folders. <a href="#fnref:ScreamingArchitecture" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:InformationHiding">
      <p><a href="https://wiki.c2.com/?InformationHiding">Information Hiding</a> is a design principle that leads to lower coupling. <a href="#fnref:InformationHiding" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:UniversalArchitecture">
      <p><a href="https://www.productivecsharp.com/2017/03/universal-architecture/">Universal Architecture</a> describes the Happy Zone as the core of the software that is very clean and easy to test. <a href="#fnref:UniversalArchitecture" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:StranglerPattern">
      <p><a href="https://martinfowler.com/bliki/StranglerFigApplication.html">Strangler Pattern</a>: An approach to improve a big system by improving one sub-system at a time until there is no sub-system left to improve. <a href="#fnref:StranglerPattern" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

    

    
      
      
      

      
    

    <p><br class="clear" /><a class="comments_link" href="/2020/08/08/levels-of-modularity.html#comments">to the comments</a></p>
  </article>
  
  
  
  <article class="post-body">
    <h2 class="post-title">
      <a href="/2020/05/11/outside-in-tdd-a-consumer.html">
        Outside-In TDD a Consumer
      </a>
    </h2>
    <div class="post-meta">
  <span class="post-date">11 May 2020</span>
  <span class="post-categories">
    
  </span>
</div>


    
      <h3 id="consumer-driven-contracts">Consumer Driven Contracts</h3>
<p><a href="https://martinfowler.com/articles/consumerDrivenContracts.html">Consumer Driven Contracts</a> (CDC) is a pattern that takes <a href="https://8thlight.com/blog/georgina-mcfadyen/2016/06/27/inside-out-tdd-vs-outside-in.html">Outside-In TDD</a> across boundaries, and is frequently used in Micro Service Architectures.
Note that TDD is not primarily a testing process, but a design technique.
The same is true for Consumer Driven Contracts where Consumers drive the capabilities of Producers by expressing a clear need.
This ties service evolution to business value.
Consumers start by writing <a href="https://martinfowler.com/bliki/ContractTest.html">Contract Tests</a> and define what a Producer’s API should be like.
The Producer is replaced by a <a href="https://martinfowler.com/articles/mocksArentStubs.html">Mock Object</a> whose configuration generates the Contract.
The interactions described in the Contract are later replayed against the Producer in a test harness.
Both, the Consumer and the Producer are tested in isolation and evolve independently.</p>

<h3 id="driving-client-code-via-consumer-tests">Driving Client Code Via Consumer Tests</h3>
<p>Another thing that the Consumer’s Contract Tests are good for is they can help emerge the client code. 
We aim for a client code that hides the technical details such as HTTP messaging and JSON serialization from us.
The client code should represent the remote service within our boundary and hide the fact that it is remote.</p>

<h3 id="defining-a-first-contract">Defining A First Contract</h3>
<p>We’re building a Book Store, so we need a Book Catalogue as a Producer.
It should serve the Book’s information.
Let’s start with a happy path for finding a single Book.
This is what the Producer Mock would look like using <a href="https://github.com/pact-foundation/pact-js">Pact JS</a>.
The definition of this Mock as well generates the Contract.
I’m skipping the boilerplate, you can look it up in my <a href="https://github.com/gregorriegler/cdc-example-typescript">github</a>.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">requestASingleBook</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">state</span><span class="p">:</span> <span class="dl">"</span><span class="s2">two books</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">uponReceiving</span><span class="p">:</span> <span class="dl">"</span><span class="s2">a request for retrieving the first book</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">withRequest</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">path</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="na">willRespondWith</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="na">headers</span><span class="p">:</span> <span class="p">{</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span><span class="p">},</span>
        <span class="na">body</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">self</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Title</span><span class="dl">"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="choices-choices-choices">Choices, Choices, Choices</h3>
<p>We can now start writing the actual Consumer Test.
But where do we start? 
What do we assert?</p>

<p>We could try to design the client code by <a href="https://wiki.c2.com/?WishfulThinking">wishful thinking</a>.</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds a single book</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// represents the producer</span>
    <span class="kd">const</span> <span class="nx">books</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Books</span><span class="p">()</span> 

    <span class="c1">// executes the http call and does json deserialization</span>
    <span class="kd">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="nx">books</span><span class="p">.</span><span class="nx">byId</span><span class="p">(</span><span class="nx">bookId</span><span class="p">)</span> 
    
    <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">deeply</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="nx">expectedBook</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>
<p>This could be a first failing test, and a nice design that hides the technical details as desired.
But it certainly is a bit premature.
We haven’t even put an API’s baseUrl.
Neither did we think about potential errors.
All the HTTP handling code would have to go to the not yet existing <code class="language-plaintext highlighter-rouge">Books</code> object. 
How would we even go about making a HTTP request?
How would we deserialize the content?
There are many things coming up, and it already feels like a huge leap.<br />
There has to be a better way.</p>

<h3 id="making-smaller-steps">Making Smaller Steps</h3>
<p>We could just ignore the design for now and focus on the technical details.
Meaning we would start and implement the HTTP call within the test.
This approach puts us closer to the technical details. 
It allows us to fiddle around, and prevents us from designing prematurely.
Later, when we experience duplication, we can extract the implementation code from the test to emerge a more mature design. 
Some would call this <a href="https://gojko.net/2009/02/27/thought-provoking-tdd-exercise-at-the-software-craftsmanship-conference/">TDD as if you meant it</a> (TDD aiymi).</p>

<h3 id="a-failing-test">A Failing Test</h3>
<p>We start by defining our final expectation, that is the book data as a result.
We don’t yet know how to get there.
All we know is the url.
Note how we don’t assert on any technical details like the HTTP Status Code and Content-Type.
These details don’t concern us, they will be hidden once we’re finished.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">requestASingleBook</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">state</span><span class="p">:</span> <span class="dl">"</span><span class="s2">two books</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">uponReceiving</span><span class="p">:</span> <span class="dl">"</span><span class="s2">a request for retrieving the first book</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">withRequest</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">path</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="na">willRespondWith</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="na">headers</span><span class="p">:</span> <span class="p">{</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span><span class="p">},</span>
        <span class="na">body</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">self</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Title</span><span class="dl">"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ... boilerplate ...</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds a single book</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://localhost:1234/books/1</span><span class="dl">"</span>
    
    <span class="kd">const</span> <span class="nx">result</span> <span class="c1">// ??</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">eq</span><span class="p">({</span><span class="na">self</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Title</span><span class="dl">"</span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>
<p>Run the tests =&gt; <strong><span style="color:red">Red</span></strong>.</p>

<h3 id="make-it-green">Make it Green</h3>
<p>Let’s find the simplest way to make the test green by writing all implementation code inside the test.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds a single book</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">bent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">bent</span><span class="dl">"</span><span class="p">)</span> <span class="c1">// bent is just a http client</span>
    <span class="kd">const</span> <span class="nx">getJSON</span> <span class="o">=</span> <span class="nx">bent</span><span class="p">(</span><span class="dl">"</span><span class="s2">json</span><span class="dl">"</span><span class="p">)</span>

    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getJSON</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://localhost:1234/books/1</span><span class="dl">"</span><span class="p">)</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">eq</span><span class="p">({</span><span class="na">self</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Title</span><span class="dl">"</span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>
<p>Run the tests =&gt; <strong><span style="color:green">Green</span></strong>.</p>

<p>Fabulous!</p>

<h3 id="refactor">Refactor</h3>
<p>As it works we can now think of improving it.
Let’s create a type for the book.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds a single book</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">bent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">bent</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">getJSON</span> <span class="o">=</span> <span class="nx">bent</span><span class="p">(</span><span class="dl">"</span><span class="s2">json</span><span class="dl">"</span><span class="p">)</span>

    <span class="kd">type</span> <span class="nx">Book</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">self</span><span class="p">:</span> <span class="kr">string</span>
        <span class="na">title</span><span class="p">:</span> <span class="kr">string</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="na">result</span><span class="p">:</span> <span class="nx">Book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getJSON</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://localhost:1234/books/1</span><span class="dl">"</span><span class="p">)</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">eq</span><span class="p">({</span><span class="na">self</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Title</span><span class="dl">"</span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>
<p>Run the tests =&gt; <strong><span style="color:green">Green</span></strong>.</p>

<h3 id="sticking-to-the-robustness-principle">Sticking To The Robustness Principle</h3>
<blockquote>
  <p>⚠ The Robustness Principle says that we should be conservative in sending stuff but liberal in receiving it.
The goal of this is to reduce the risk for messages to fail.</p>
</blockquote>

<p>Consumers should be tolerant to API change, able to survive most of it. 
They should only be concerned with the Resources, Methods and Fields they actually consume, and treat even them with care.</p>

<p>In the existing solution a new arriving field would cause the message to fail. <br />
Let’s imagine the server would add a new field: <code class="language-plaintext highlighter-rouge">description</code>.
Our client code would not expect it and break.
We need to make it more robust and prevent this from happening.</p>

<p>But, should we not write a test first proving that it would break?</p>

<p>Totally!
However, we are currently in the writing of a Consumer Test. 
It generates the Contract for the Producer.
Adding the <code class="language-plaintext highlighter-rouge">description</code> field to the Contract is not what we want.
We only want to add the fields that we consume.
So let’s</p>
<ol>
  <li>add the field temporarily to prove that it breaks,</li>
  <li>fix the implementation to not break anymore,</li>
  <li>and finally remove the field again.</li>
</ol>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds a single book</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">bent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">bent</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">getJSON</span> <span class="o">=</span> <span class="nx">bent</span><span class="p">(</span><span class="dl">"</span><span class="s2">json</span><span class="dl">"</span><span class="p">)</span>

    <span class="kd">type</span> <span class="nx">Book</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">self</span><span class="p">:</span> <span class="kr">string</span>
        <span class="na">title</span><span class="p">:</span> <span class="kr">string</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">decodeBook</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">):</span> <span class="nx">Book</span> <span class="o">=&gt;</span> <span class="p">({</span>
        <span class="na">self</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nb">self</span><span class="p">,</span>
        <span class="na">title</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">title</span>
    <span class="p">});</span>

    <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getJSON</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://localhost:1234/books/1</span><span class="dl">"</span><span class="p">)</span>

    <span class="kd">const</span> <span class="na">book</span><span class="p">:</span> <span class="nx">Book</span> <span class="o">=</span> <span class="nx">decodeBook</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">eq</span><span class="p">({</span><span class="na">self</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Title</span><span class="dl">"</span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>
<p>Run the tests =&gt; <strong><span style="color:green">Green</span></strong>.</p>

<p>The <code class="language-plaintext highlighter-rouge">decodeBook</code> function makes the code robust against any change to fields that we don’t consume.</p>

<h3 id="aiming-for-duplication">Aiming For Duplication</h3>
<p>Already fiddling around a lot, aren’t we?
Let’s aim for some duplication by implementing the not found case.
We can just copy and paste the earlier test and adapt it.
Shouldn’t have to change much, should we?</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">requestANonExistingBook</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">state</span><span class="p">:</span> <span class="dl">"</span><span class="s2">two books</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">uponReceiving</span><span class="p">:</span> <span class="dl">"</span><span class="s2">a request for a non existing book</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">withRequest</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">path</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/books/3</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="na">willRespondWith</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">status</span><span class="p">:</span> <span class="mi">404</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="c1">// ... boilerplate ...</span>


<span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds nothing</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">import</span> <span class="p">{</span><span class="nx">none</span><span class="p">,</span> <span class="nx">Option</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">fp-ts/lib/Option</span><span class="dl">"</span>
    <span class="kd">const</span> <span class="nx">bent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">bent</span><span class="dl">"</span><span class="p">)</span>

    <span class="kd">type</span> <span class="nx">Book</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">self</span><span class="p">:</span> <span class="kr">string</span>
        <span class="na">title</span><span class="p">:</span> <span class="kr">string</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">decodeBook</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">):</span> <span class="nx">Book</span> <span class="o">=&gt;</span> <span class="p">({</span>
        <span class="na">self</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nb">self</span><span class="p">,</span>
        <span class="na">title</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">title</span>
    <span class="p">});</span>

    <span class="kd">const</span> <span class="nx">getStream</span> <span class="o">=</span> <span class="nx">bent</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://localhost:1234/books/3</span><span class="dl">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getStream</span><span class="p">()</span>
    <span class="kd">let</span> <span class="na">book</span><span class="p">:</span><span class="nx">Option</span><span class="o">&lt;</span><span class="nx">Book</span><span class="o">&gt;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">received </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
        <span class="nx">book</span> <span class="o">=</span> <span class="nx">none</span>
    <span class="p">}</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">none</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>
<p>Run the tests =&gt; <strong><span style="color:green">Green</span></strong>.</p>

<p>That escalated quickly.
The implementation changed quite a bit.
We had to change the way we use bent to support the 404 status code.
Also, we decided to introduce the Option type to make explicit a book might not be returned.
The two tests look quite different now.</p>

<h3 id="finding-the-common-denominator">Finding The Common Denominator</h3>
<p>Before we can extract it as production code we need to adapt both tests to match each other.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds a single book</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">import</span> <span class="p">{</span><span class="nx">none</span><span class="p">,</span> <span class="nx">Option</span><span class="p">,</span> <span class="nx">some</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">fp-ts/lib/Option</span><span class="dl">"</span>
    <span class="kd">const</span> <span class="nx">bent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">bent</span><span class="dl">"</span><span class="p">)</span>

    <span class="kd">type</span> <span class="nx">Book</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">self</span><span class="p">:</span> <span class="kr">string</span>
        <span class="na">title</span><span class="p">:</span> <span class="kr">string</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">decodeBook</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">):</span> <span class="nx">Book</span> <span class="o">=&gt;</span> <span class="p">({</span>
        <span class="na">self</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nb">self</span><span class="p">,</span>
        <span class="na">title</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">title</span>
    <span class="p">});</span>

    <span class="kd">const</span> <span class="nx">getStream</span> <span class="o">=</span> <span class="nx">bent</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://localhost:1234</span><span class="dl">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getStream</span><span class="p">(</span><span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">let</span> <span class="na">book</span><span class="p">:</span><span class="nx">Option</span><span class="o">&lt;</span><span class="nx">Book</span><span class="o">&gt;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">received </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
        <span class="nx">book</span> <span class="o">=</span> <span class="nx">none</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">book</span> <span class="o">=</span> <span class="nx">some</span><span class="p">(</span><span class="nx">decodeBook</span><span class="p">(</span><span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">json</span><span class="p">()))</span>
    <span class="p">}</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="nx">some</span><span class="p">({</span><span class="na">self</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Title</span><span class="dl">"</span><span class="p">}))</span>
<span class="p">})</span>

<span class="c1">// ...</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds nothing</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">import</span> <span class="p">{</span><span class="nx">none</span><span class="p">,</span> <span class="nx">Option</span><span class="p">,</span> <span class="nx">some</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">fp-ts/lib/Option</span><span class="dl">"</span>
    <span class="kd">const</span> <span class="nx">bent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">bent</span><span class="dl">"</span><span class="p">)</span>

    <span class="kd">type</span> <span class="nx">Book</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">self</span><span class="p">:</span> <span class="kr">string</span>
        <span class="na">title</span><span class="p">:</span> <span class="kr">string</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">decodeBook</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">):</span> <span class="nx">Book</span> <span class="o">=&gt;</span> <span class="p">({</span>
        <span class="na">self</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nb">self</span><span class="p">,</span>
        <span class="na">title</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">title</span>
    <span class="p">});</span>

    <span class="kd">const</span> <span class="nx">getStream</span> <span class="o">=</span> <span class="nx">bent</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://localhost:1234</span><span class="dl">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getStream</span><span class="p">(</span><span class="dl">"</span><span class="s2">/books/3</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">let</span> <span class="na">book</span><span class="p">:</span><span class="nx">Option</span><span class="o">&lt;</span><span class="nx">Book</span><span class="o">&gt;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">received </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
        <span class="nx">book</span> <span class="o">=</span> <span class="nx">none</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">book</span> <span class="o">=</span> <span class="nx">some</span><span class="p">(</span><span class="nx">decodeBook</span><span class="p">(</span><span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">json</span><span class="p">()))</span>
    <span class="p">}</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">none</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>
<p>Run the tests =&gt; <strong><span style="color:green">Green</span></strong>.</p>

<h3 id="extract-duplication">Extract Duplication</h3>
<p>Ok, great. 
The implementation code is now the same in both cases: Finding a book, and not finding it.
We can finally start and extract the duplicated parts out of the tests.
Let’s begin with the Book type, and the <code class="language-plaintext highlighter-rouge">decodeBook</code> function.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span><span class="nx">none</span><span class="p">,</span> <span class="nx">Option</span><span class="p">,</span> <span class="nx">some</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">fp-ts/lib/Option</span><span class="dl">"</span>
<span class="kd">const</span> <span class="nx">bent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">bent</span><span class="dl">"</span><span class="p">)</span>

<span class="kd">type</span> <span class="nx">Book</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">self</span><span class="p">:</span> <span class="kr">string</span>
    <span class="na">title</span><span class="p">:</span> <span class="kr">string</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">decodeBook</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">):</span> <span class="nx">Book</span> <span class="o">=&gt;</span> <span class="p">({</span>
    <span class="na">self</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nb">self</span><span class="p">,</span>
    <span class="na">title</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">title</span>
<span class="p">});</span>

<span class="c1">// ...</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds a single book</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://localhost:1234</span><span class="dl">"</span>
    <span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span>
    
    <span class="kd">const</span> <span class="nx">getStream</span> <span class="o">=</span> <span class="nx">bent</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getStream</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="kd">let</span> <span class="na">book</span><span class="p">:</span><span class="nx">Option</span><span class="o">&lt;</span><span class="nx">Book</span><span class="o">&gt;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">received </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
        <span class="nx">book</span> <span class="o">=</span> <span class="nx">none</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">book</span> <span class="o">=</span> <span class="nx">some</span><span class="p">(</span><span class="nx">decodeBook</span><span class="p">(</span><span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">json</span><span class="p">()))</span>
    <span class="p">}</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="nx">some</span><span class="p">({</span><span class="na">self</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Title</span><span class="dl">"</span><span class="p">}))</span>
<span class="p">})</span>

<span class="c1">// ...</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds nothing</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://localhost:1234</span><span class="dl">"</span>
    <span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/books/3</span><span class="dl">"</span>
    
    <span class="kd">const</span> <span class="nx">getStream</span> <span class="o">=</span> <span class="nx">bent</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getStream</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="kd">let</span> <span class="na">book</span><span class="p">:</span><span class="nx">Option</span><span class="o">&lt;</span><span class="nx">Book</span><span class="o">&gt;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">received </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
        <span class="nx">book</span> <span class="o">=</span> <span class="nx">none</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">book</span> <span class="o">=</span> <span class="nx">some</span><span class="p">(</span><span class="nx">decodeBook</span><span class="p">(</span><span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">json</span><span class="p">()))</span>
    <span class="p">}</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">none</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>
<p>Run the tests =&gt; <strong><span style="color:green">Green</span></strong>.</p>

<p>Note how I as well extracted both the <code class="language-plaintext highlighter-rouge">baseUrl</code> and <code class="language-plaintext highlighter-rouge">path</code> variables inside the tests.
This allows us to further extract the function that does the actual request.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span><span class="nx">none</span><span class="p">,</span> <span class="nx">Option</span><span class="p">,</span> <span class="nx">some</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">fp-ts/lib/Option</span><span class="dl">"</span>
<span class="kd">const</span> <span class="nx">bent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">bent</span><span class="dl">"</span><span class="p">)</span>

<span class="kd">type</span> <span class="nx">Book</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">self</span><span class="p">:</span> <span class="kr">string</span>
    <span class="na">title</span><span class="p">:</span> <span class="kr">string</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">decodeBook</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">):</span> <span class="nx">Book</span> <span class="o">=&gt;</span> <span class="p">({</span>
    <span class="na">self</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nb">self</span><span class="p">,</span>
    <span class="na">title</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">title</span>
<span class="p">});</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">findBook</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">path</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Option</span><span class="o">&lt;</span><span class="nx">Book</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">getStream</span> <span class="o">=</span> <span class="nx">bent</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getStream</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="kd">let</span> <span class="na">book</span><span class="p">:</span> <span class="nx">Option</span><span class="o">&lt;</span><span class="nx">Book</span><span class="o">&gt;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">received </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
        <span class="nx">book</span> <span class="o">=</span> <span class="nx">none</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">book</span> <span class="o">=</span> <span class="nx">some</span><span class="p">(</span><span class="nx">decodeBook</span><span class="p">(</span><span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">json</span><span class="p">()))</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">book</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds a single book</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://localhost:1234</span><span class="dl">"</span>
    <span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span>

    <span class="kd">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">findBook</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="nx">some</span><span class="p">({</span><span class="na">self</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Title</span><span class="dl">"</span><span class="p">}))</span>
<span class="p">})</span>

<span class="c1">// ...</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds nothing</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://localhost:1234</span><span class="dl">"</span>
    <span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/books/3</span><span class="dl">"</span>

    <span class="kd">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">findBook</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">none</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>
<p>Run the tests =&gt; <strong><span style="color:green">Green</span></strong>.</p>

<h3 id="final-touch">Final Touch</h3>
<p>The tests became nice and short.
However, I would prefer having a bookClient object that had the <code class="language-plaintext highlighter-rouge">baseUrl</code> baked in.
This would allow me to add more functions later.
So I refactor it further, and extract the module.
The final result looks like this:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// content of book-client.ts</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">none</span><span class="p">,</span> <span class="nx">Option</span><span class="p">,</span> <span class="nx">some</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">fp-ts/lib/Option</span><span class="dl">"</span>
<span class="kd">const</span> <span class="nx">bent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">bent</span><span class="dl">"</span><span class="p">)</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">createBookClient</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">type</span> <span class="nx">Book</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">self</span><span class="p">:</span> <span class="kr">string</span>
        <span class="na">title</span><span class="p">:</span> <span class="kr">string</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">decodeBook</span> <span class="o">=</span> <span class="p">(</span><span class="nx">object</span><span class="p">):</span> <span class="nx">Book</span> <span class="o">=&gt;</span> <span class="p">({</span>
        <span class="na">self</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nb">self</span><span class="p">,</span>
        <span class="na">title</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="nx">title</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="na">requestBook</span><span class="p">:</span> <span class="k">async</span> <span class="p">(</span><span class="na">path</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Option</span><span class="o">&lt;</span><span class="nx">Book</span><span class="o">&gt;&gt;</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">getStream</span> <span class="o">=</span> <span class="nx">bent</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
            <span class="kd">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getStream</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">received </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">status</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
                <span class="k">return</span> <span class="nx">none</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">some</span><span class="p">(</span><span class="nx">decodeBook</span><span class="p">(</span><span class="k">await</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">json</span><span class="p">()))</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// content of tests</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">createBookClient</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./book-client</span><span class="dl">"</span>

<span class="c1">// ...</span>

<span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">createBookClient</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://localhost:1234</span><span class="dl">"</span><span class="p">)</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds a single book</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">requestBook</span><span class="p">(</span><span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span><span class="p">)</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="nx">some</span><span class="p">({</span><span class="na">self</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/books/1</span><span class="dl">"</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Title</span><span class="dl">"</span><span class="p">}))</span>
<span class="p">})</span>

<span class="c1">// ...</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">finds nothing</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">requestBook</span><span class="p">(</span><span class="dl">"</span><span class="s2">/books/3</span><span class="dl">"</span><span class="p">)</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">none</span><span class="p">)</span>
<span class="p">})</span>

</code></pre></div></div>
<p>Run the tests =&gt; <strong><span style="color:green">Green</span></strong>.</p>

<p>And we are finished.</p>

<h3 id="conclusion">Conclusion</h3>
<p>We drove a clean client code from writing Consumer Tests.
We used the tests to fiddle around with technical implementation detail.
Once we had tested more cases, we aligned their implementations to extract common code.
The design we arrived at is a little different from the one we had originally anticipated.</p>

<p>TDD leaves us with a choice when to design.<br />
We can do it upfront by wishful thinking - in the Red Phase.<br />
Or we can defer it to a later stage - in the Refactoring Phase.<br />
The latter makes it easier to fiddle around with the details and may lead to a more mature design.</p>

<p>You can find the code on my <a href="https://github.com/gregorriegler/cdc-example-typescript">github</a>.</p>


    

    
      
      
      

      
    

    <p><br class="clear" /><a class="comments_link" href="/2020/05/11/outside-in-tdd-a-consumer.html#comments">to the comments</a></p>
  </article>
  
  
  
  
  
  
  
  
  
  

  
<div class="pagination">
  <a class="pagination-item older"
     href="/blog/page/3/index.html">
    Older
  </a>
</div>


</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
